Vamos a isso. Entramos na **Fase 5: QoS (DiffServ)**.

O objetivo aqui é garantir que o tráfego do **Cliente L2** (que viaja pela rede "normal" fora do túnel MPLS-TE) tenha tratamento preferencial (Assured Forwarding) em caso de congestionamento.

Vamos implementar isto em **duas partes**:

1. **Marcação (Nos Leafs Linux):** "Pintar" os pacotes com uma cor (DSCP) antes de saírem para a rede.
2. **Tratamento (Nos Ciscos):** "Ler a cor" e dar prioridade na fila.

---

### Parte 1: Marcar os Pacotes no Linux (Leafs)

Como os routers Cisco não conseguem ver o que está dentro do pacote VXLAN (está encriptado/encapsulado), temos de marcar o cabeçalho IP exterior (o envelope).

Vamos usar o **DSCP 26** (que equivale ao **AF31** - Assured Forwarding Class 3, Low Drop).

**Lógica:** "Todo o tráfego VXLAN (UDP 4789) que sai deste Leaf com origem no meu IP de VTEP Normal (`10.0.0.x`), leva a marca AF31."
*(Nota: O tráfego do Cliente L1 não será afetado porque sai com o IP secundário `10.0.0.1xx` e entra no Túnel TE).*

**Executa estes comandos no terminal BASH (sai do vtysh) dos Leafs:**

**No Leaf L11 (Lisboa):**

```bash
# Regra: Se sai (OUTPUT) protocolo UDP porta 4789 (VXLAN)
# E a origem é o meu Loopback0 (10.0.0.21 - VTEP do Cliente L2)
# Então marca com DSCP 26 (AF31)
iptables -t mangle -A OUTPUT -p udp --dport 4789 -s 10.0.0.21 -j DSCP --set-dscp 26

```

**No Leaf L21 (Porto):**

```bash
# A mesma lógica, mas com o IP do L21
iptables -t mangle -A OUTPUT -p udp --dport 4789 -s 10.0.0.31 -j DSCP --set-dscp 26

```

*Nota:* Se reiniciares os contentores, estas regras perdem-se (a menos que as ponhas num script de arranque), mas para a demonstração serve perfeitamente.

---

### Parte 2: Configurar o QoS no Router Cisco (Lisbon e Porto)

Agora vamos ensinar o Cisco a respeitar essa marcação. Vamos configurar o router `Lisbon` (e deves fazer igual no `Porto`).

**No Router `Lisbon`:**

```bash
configure terminal

! 1. Classificação: Criar um mapa para identificar o tráfego AF31
class-map match-all CLIENTE_L2_AF
 match ip dscp af31
!

! 2. Política: Definir o que fazer (Garantir banda)
policy-map QOS_CLIENTE_L2
 class CLIENTE_L2_AF
  bandwidth 10000         ! Garante 10 Mbps mínimos para esta classe
  random-detect           ! (Opcional) Ajuda a evitar congestão TCP
 class class-default
  fair-queue              ! O resto do tráfego divide-se equitativamente
!

! 3. Aplicação: Aplicar na interface que SAI para o Core
! (Confirma qual é a interface ligada ao Core1 ou Core2. Ex: FastEthernet0/0)
interface FastEthernet0/0
 service-policy output QOS_CLIENTE_L2
!
interface FastEthernet0/1
 service-policy output QOS_CLIENTE_L2
!
end
write

```

---

### Parte 3: Como Validar (O Teste Final)

Agora vamos ver se a magia acontece.

1. **Gera Tráfego:**
Vai ao Leaf L11 e faz um ping contínuo e rápido para o cliente L2 no Porto:
`ping 10.40.0.2 -i 0.2` (envia 5 pacotes por segundo).
2. **Verifica no Cisco:**
Vai ao Router `Lisbon` e corre o comando de verificação:
`show policy-map interface FastEthernet0/0` (ou a interface onde aplicaste).

**O que deves ver:**
Procura a secção `Class-map: CLIENTE_L2_AF`.
Se o contador `Packets` estiver a aumentar, parabéns!

1. O Linux marcou o pacote.
2. O Cisco leu a marcação.
3. O tráfego está a ser colocado na fila prioritária de 10Mbps.

Diz-me se os contadores subiram! Se sim, terminaste a configuração técnica do projeto.
