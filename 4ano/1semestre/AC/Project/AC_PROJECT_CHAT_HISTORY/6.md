Isso é uma excelente notícia! Se o OSPF já está a funcionar e o *Underlay* (a infraestrutura base) tem conectividade, ultrapassaste a maior barreira inicial.

Agora entramos na **Fase 2: Overlay (BGP EVPN & VXLAN)**.

Vamos construir a "rede virtual" por cima da infraestrutura que acabaste de montar. O objetivo é que os Switches troquem endereços MAC via BGP (Control Plane) e encapsulem o tráfego dos clientes em túneis UDP (VXLAN).

Dividi isto em duas partes para não confundir: **BGP** (Configuração nos routers) e **VXLAN** (Configuração no Linux Bash).

---

### Parte 1: Configurar o BGP EVPN (O "Cérebro")

Nesta arquitetura (Spine-Leaf), os **Spines (S1, S2)** vão funcionar como *Route Reflectors*. Eles não têm clientes ligados diretamente; eles apenas recebem as rotas dos Leafs e reencaminham para os outros Leafs.

**AS Number:** Vamos usar **22900** (dado no enunciado ).

#### 1. Configurar o Spine (Ex: S1)

Tens de configurar o BGP para falar com todos os Leafs desse Data Center.

* **Onde:** `vtysh` -> `conf t`
* **Lógica:**
1. Desativar o BGP padrão IPv4 (não precisamos dele para routing base, já temos OSPF).
2. Ativar a família `l2vpn evpn`.
3. Definir os vizinhos (Leafs) como clientes de reflexão de rotas.



```bash
! No Spine S1 (10.0.0.11)
router bgp 22900
 bgp router-id 10.0.0.11
 no bgp default ipv4-unicast       ! Opcional, mas limpa a config
 neighbor LEAFS peer-group         ! Cria um grupo para poupar trabalho
 neighbor LEAFS remote-as 22900
 neighbor LEAFS update-source lo   ! Usa a Loopback para estabilidade
 !
 ! Define os teus vizinhos (Leafs de Lisboa)
 neighbor 10.0.0.21 peer-group LEAFS
 neighbor 10.0.0.22 peer-group LEAFS
 neighbor 10.0.0.23 peer-group LEAFS
 !
 address-family l2vpn evpn
  neighbor LEAFS activate
  neighbor LEAFS route-reflector-client  ! O segredo do Spine
 exit-address-family
!

```

*(Repete a lógica para o S2 no Porto, apontando para os Leafs L21, L22, L23)*.

#### 2. Configurar o Leaf (Ex: L11)

O Leaf é onde a magia acontece. Ele anuncia os VNIs (Virtual Network Identifiers).

```bash
! No Leaf L11 (10.0.0.21)
router bgp 22900
 bgp router-id 10.0.0.21
 no bgp default ipv4-unicast
 neighbor 10.0.0.11 remote-as 22900
 neighbor 10.0.0.11 update-source lo
 !
 address-family l2vpn evpn
  neighbor 10.0.0.11 activate
  advertise-all-vni              ! Anuncia todos os VXLANs que criares
 exit-address-family
!

```

*(Repete para todos os Leafs, apontando para o respetivo Spine)*.

---

### Parte 2: Configurar VXLAN e Bridges (O "Músculo")

**Atenção:** Como refere o teu guião, o FRRouting (versões standard usadas nas aulas) muitas vezes não configura interfaces VXLAN via `vtysh`. Temos de usar comandos **Linux Bash** diretos.

Vamos configurar dois clientes diferentes. Aqui aplicamos o "truque" para o **Cisco conseguir distinguir o tráfego**:

* **Cliente L2 (Normal):** Usa a `Loopback0` (IP normal) como origem do túnel.
* **Cliente L1 (Premium/TE):** Usa a `Loopback1` (IP secundário) como origem do túnel.

Sai do `vtysh` (`exit`) e corre isto no terminal **Bash** do Leaf (ex: L11).

#### 1. Configuração para o Cliente L1 (VLAN 10 -> VNI 10) - O Cliente Premium

Nota o `local 10.0.0.121` (o tal IP secundário da Loopback1).

```bash
# Criar Interface VXLAN para VNI 10 (Cliente L1)
ip link add vxlan10 type vxlan id 10 local 10.0.0.121 dstport 4789 nolearning
ip link set up dev vxlan10

# Criar a Ponte (Bridge) para misturar a VLAN com o VXLAN
ip link add br10 type bridge
ip link set up dev br10

# Ligar o VXLAN à Ponte
ip link set vxlan10 master br10

# Simular a ligação ao "Rack" (Cliente)
# Vamos assumir que a eth1 liga ao servidor/switch do rack
# Criar subinterface para VLAN 10
ip link add link eth1 name eth1.10 type vlan id 10
ip link set up dev eth1.10
ip link set eth1.10 master br10

```

#### 2. Configuração para o Cliente L2 (LAN -> VNI 40) - O Cliente Normal

Nota o `local 10.0.0.21` (o IP normal da Loopback0).

```bash
# Criar Interface VXLAN para VNI 40 (Cliente L2)
ip link add vxlan40 type vxlan id 40 local 10.0.0.21 dstport 4789 nolearning
ip link set up dev vxlan40

# Criar a Ponte
ip link add br40 type bridge
ip link set up dev br40

# Ligar
ip link set vxlan40 master br40

# Ligar ao Rack (VLAN 40 ou untagged, conforme o design)
# Assumindo VLAN 40 para o Cliente L2 também:
ip link add link eth1 name eth1.40 type vlan id 40
ip link set up dev eth1.40
ip link set eth1.40 master br40

```

---

### O Teu Trabalho Agora

1. **Configura o BGP** no Spine S1 e no Leaf L11 (Lisboa).
2. **Configura o BGP** no Spine S2 e no Leaf L21 (Porto).
3. **Verifica o BGP:** No S1, faz `show bgp l2vpn evpn summary`. Deves ver o L11 conectado.
4. **Configura o VXLAN (Bash)** no L11 e L21 para o VNI 40 (Cliente L2) primeiro, para testarmos o mais simples.
5. **Persistência:** Lembra-te que os comandos Bash desaparecem se reiniciares o contentor. O guião sugere colocar no `/etc/init.d/` ou num script de arranque se for necessário reiniciar.



Quando tiveres o BGP "up" entre Spines e Leafs, avisa-me para testarmos a conectividade VXLAN entre Lisboa e Porto!
