Este é um projeto complexo e bastante completo que combina quase todos os tópicos dos guiões anteriores: **Datacenter (VXLAN/EVPN)**, **Core WAN (MPLS/OSPF)** e **QoS (DiffServ/TE)**.

Aqui está a análise detalhada e o plano de ação passo a passo.

---

### 1. Análise do Cenário

O objetivo é interligar dois Data Centers (Lisboa e Porto) através de um Core MPLS proprietário, garantindo requisitos específicos para dois clientes (L1 e L2).

#### A Arquitetura

1. **Core da Rede (Underlay WAN):**
* Composto pelos routers Cisco 7200: `Lisbon`, `Porto`, `Core1`, `Core2`.
* **Protocolos:** OSPF (IGP), MPLS (LDP para etiquetas base), MPLS-TE (para engenharia de tráfego do Cliente L1).
* **Função:** Transportar pacotes IP de um lado para o outro. **Importante:** Os routers Cisco **não sabem** o que é VXLAN (Nota 4). Eles veem apenas pacotes UDP a viajar entre os IPs dos Switches Linux.


2. **Data Center (Overlay & Access):**
* Composto por contentores Linux FRR: Spines (`S1`, `S2`) e Leafs (`L1x`, `L2x`).
* **Protocolos:** OSPF (para os Loopbacks dos VTEPs), BGP EVPN (para troca de MACs e criação dos túneis VXLAN).
* **Função:** Criar a "Ethernet Private Network" (Layer 2 estendido). Os Leafs encapsulam o tráfego dos clientes em VXLAN (UDP port 4789).



#### Os Clientes e Desafios

* **Cliente L1 (Crítico):**
* Tem 3 VLANs.
* Exige **10Mbps garantidos** e **Alta Resiliência**.
* *Solução Implícita:* Vais precisar de **MPLS Traffic Engineering (RSVP-TE)** no Core Cisco para reservar banda e criar caminhos primários/backup para o tráfego deste cliente.


* **Cliente L2 (Diferenciado):**
* Rede simples.
* Exige priorização **Assured Forwarding (AF)**.
* *Solução Implícita:* Vais precisar de **DiffServ (QoS)**. Os switches Linux têm de marcar os pacotes (DSCP) e o Core Cisco tem de honrar essa marcação e tratar as filas (Queuing) de acordo.



---

### 2. Plano de Implementação (Passo a Passo)

Divide o projeto em 4 fases lógicas para não te perderes.

#### Fase 1: Fundação (Endereçamento e Core Básico)

*O objetivo é que todos os routers Cisco e Switches Linux tenham conectividade IP básica.*

1. **Endereçamento IP (Crucial):**
* Define uma gama para Loopbacks (ex: `10.0.0.x/32`).
* Define gamas para as ligações Core (ex: `10.0.10.x/30`).
* Define gamas para dentro do DC (Links Spine-Leaf).
* *Dica:* Usa o último octeto igual ao ID do router (ex: Router 1 = `.1`).


2. **Configuração Cisco (Core):**
* Configurar interfaces e IPs.
* Ativar **OSPF** (Area 0) em todos os Ciscos e nas interfaces que ligam aos Spines Linux (`S1` e `S2`).
* Ativar **MPLS LDP** (`mpls ip`) nas interfaces entre routers Cisco.
* *Teste:* O `Lisbon` deve conseguir pingar o `Porto` e o `Core1/2`.



#### Fase 2: O Data Center (VXLAN e EVPN)

*O objetivo é que os clientes consigam falar L2 entre racks do mesmo DC, e depois entre DCs.*

1. **Underlay do DC:**
* Nos Linux (S1, S2, Lxx), configurar IPs e **OSPF**.
* O objetivo é que o Leaf `L11` consiga pingar o IP de Loopback do Leaf `L21` (que está no outro DC, passando pelo Core Cisco).


2. **Overlay EVPN:**
* Configurar **iBGP** entre Leafs e Spines (Route Reflectors).
* Ativar a `address-family l2vpn evpn`.
* Configurar as **VRFs** e **VXLANs** nos Leafs para o Cliente L1 (VNI 10, 20, 30) e Cliente L2 (VNI 40).
* Mapear VLANs para VNIs.


3. **Teste de Conectividade Básica:**
* Um PC no Rack 11 (Lisboa) deve conseguir pingar um PC no Rack 21 (Porto) na mesma VLAN.
* *Nota:* Neste momento, tudo funciona, mas sem garantias de QoS ou largura de banda.



#### Fase 3: Requisitos do Cliente L1 (MPLS-TE)

*O objetivo é proteger e reservar banda para o Cliente L1 no Core.*

1. **Isolar o Tráfego L1:**
* Como o Cisco não vê VXLAN, tens de diferenciar o tráfego pelo IP de origem/destino (os VTEPs).
* *Estratégia:* Define IPs de Loopback secundários nos Leafs exclusivos para o tunnelamento do Cliente L1. Ou, assume que todo o tráfego entre certos pares de Leafs é L1.


2. **Configurar RSVP-TE no Core Cisco:**
* Ativar `mpls traffic-eng tunnels` e `ip rsvp bandwidth` nas interfaces Cisco.
* Configurar OSPF com extensões MPLS-TE (`mpls traffic-eng area 0`).


3. **Criar Túneis TE:**
* No router `Lisbon`, criar um **Tunnel Interface** apontado para o router `Porto`.
* Configurar `tunnel mpls traffic-eng bandwidth 10000` (10 Mbps).
* Configurar `path-option` para definir caminhos explícitos ou dinâmicos com proteção (Fast Reroute).


4. **Encaminhar Tráfego para o Túnel:**
* Usar rotas estáticas ou Policy Based Routing (PBR) no router `Lisbon` para que o tráfego UDP (VXLAN) destinado aos VTEPs do Porto (para o cliente L1) entre neste Túnel TE, em vez de seguir o caminho normal OSPF.



#### Fase 4: Requisitos do Cliente L2 (DiffServ/QoS)

*O objetivo é dar prioridade AF (Assured Forwarding) ao Cliente L2.*

1. **Marcação (No Linux/Leaf):**
* Nos Leafs, configurar regras (`iptables` ou via ponte) para marcar os pacotes de saída do Cliente L2 com um valor DSCP específico (ex: AF31 ou DSCP 26). O pacote VXLAN (UDP) deve sair já marcado.


2. **Classificação e Policiamento (No Cisco Ingress):**
* No router `Lisbon` (interface virada para o S1), criar `class-map` para identificar esse DSCP.
* Criar `policy-map` para garantir que esse tráfego não excede o contratado (policing) se necessário, ou apenas confiar na marcação.


3. **Queuing (No Core):**
* Nas interfaces de saída dos routers Cisco (entre Core1/Core2), configurar `policy-map` de saída.
* Atribuir uma fila com garantia de banda (`bandwidth percent ...`) para a classe AF definida.



---

### Resumo das Tecnologias a usar por Dispositivo

| Dispositivo | Função | Tecnologias Chave (Guiões) |
| --- | --- | --- |
| **Lxx (Leafs)** | VTEP Access | Linux FRR, OSPF, BGP EVPN, VXLAN Bridge, Marcação DSCP (iptables). |
| **S1/S2 (Spines)** | Refletor / Gateway | Linux FRR, OSPF, BGP Route Reflector. |
| **Lisbon/Porto** | PE Router / Head-end | Cisco IOS, OSPF, MPLS LDP, **RSVP-TE**, PBR (para direcionar tráfego para o túnel), QoS (DiffServ). |
| **Core1/Core2** | P Router | Cisco IOS, OSPF, MPLS LDP, RSVP-TE, QoS (Queuing). |

### Dica de Ouro (Sobre a Nota 4)

O enunciado diz: *"Cisco Routers can not route based on VXLAN VNIs... routing must be done based only on UDP ports and/or different source and destination IPv4 addresses."*

Isto significa que para separares o tráfego do L1 (que precisa de Túnel TE) do tráfego normal, a forma mais fácil é:
Nos Leafs Linux, usa **IPs de Loopback diferentes para originar o túnel VXLAN** dependendo do cliente.

* Loopback0 (10.0.0.1) -> Usado para VXLAN do Cliente L2.
* Loopback1 (10.0.0.101) -> Usado para VXLAN do Cliente L1.

Assim, no router Cisco `Lisbon`, podes dizer: "Se o destino IP é 10.0.0.101 (VTEP L1 remoto), manda pelo Túnel MPLS-TE com reserva de banda. Se for 10.0.0.1, manda pelo routing normal OSPF".

Queres começar pela **Fase 1 (Endereçamento e GNS3)** ou preferes ver um exemplo de configuração para a **Fase 2 (VXLAN)**?
