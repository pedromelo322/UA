Isso √© uma grande vit√≥ria! üéâ Se o ping j√° funciona, significa que tens uma infraestrutura **Spine-Leaf com BGP EVPN e VXLAN** totalmente funcional a atravessar um Core MPLS.

Agora vamos cumprir o requisito mais dif√≠cil: **Garantir 10Mbps e Resili√™ncia para o Cliente L1** usando MPLS Traffic Engineering (TE).

Como o Core Cisco n√£o sabe o que √© VXLAN, vamos diferenciar os clientes pelo IP de destino do VTEP (o IP do Leaf que recebe o t√∫nel).

* **Cliente L2 (Normal):** Vai para o IP normal do Leaf (`10.0.0.31`). Segue o caminho OSPF normal.
* **Cliente L1 (Premium):** Vai para o IP secund√°rio do Leaf (`10.0.0.131`). O Cisco `Lisbon` vai ver esse IP e for√ßar o tr√°fego a entrar num T√∫nel TE com reserva de banda.

Vamos configurar isto em **3 Etapas**.

---

### Etapa 1: Preparar o Core Cisco para TE (Nos 4 Routers)

Tens de ativar o suporte a TE globalmente, no OSPF e nas interfaces f√≠sicas que ligam os routers Cisco.

**Configura√ß√£o a aplicar em: `Lisbon`, `Porto`, `Core1`, `Core2**`

```bash
! 1. Ativar suporte global
configure terminal
mpls traffic-eng tunnels

! 2. Configurar interfaces F√çSICAS (f0/0, f0/1, etc.)
! ATEN√á√ÉO: S√≥ nas que ligam Cisco <-> Cisco. N√£o nas que ligam aos Linux.
interface FastEthernet0/0
 mpls traffic-eng tunnels
 ip rsvp bandwidth 100000     ! Dizemos que h√° 100Mbps dispon√≠veis para reservar
 exit
! (Repete para a outra interface se houver, ex: f0/1)

! 3. Configurar OSPF para transportar informa√ß√£o de TE
router ospf 1
 mpls traffic-eng area 0
 mpls traffic-eng router-id Loopback0
 exit

```

*Dica:* Depois de fazeres isto nos 4 routers, corre `clear ip ospf process` em cada um para garantir que a base de dados OSPF atualiza.

---

### Etapa 2: Criar o T√∫nel TE (Apenas no Router `Lisbon`)

Vamos criar o "tubo" reservado que vai de Lisboa at√© ao Porto.

**No Router `Lisbon`:**

```bash
configure terminal
interface Tunnel1
 description Tunel_Premium_Cliente_L1
 ip unnumbered Loopback0       ! Usa o IP do router como origem
 tunnel destination 10.0.0.4   ! IP Loopback0 do Router Porto
 tunnel mode mpls traffic-eng
 !
 ! O Requisito: Garantir 10 Mbps (10000 kbps)
 tunnel mpls traffic-eng bandwidth 10000
 !
 ! O Requisito: Resili√™ncia (Caminho din√¢mico)
 tunnel mpls traffic-eng path-option 1 dynamic
 exit

```

**Verifica√ß√£o:**
Faz `show mpls traffic-eng tunnels`.
O estado deve ser **Admin: up, Oper: up**. Se estiver "down", confirma se o OSPF tem o TE ativo em todos os routers interm√©dios.

---

### Etapa 3: "Encaminhar" o Cliente L1 para o T√∫nel

Agora ensinamos o router `Lisbon`: *"Se vires tr√°fego a ir para o VTEP do Cliente L1 no Porto (`10.0.0.131`), n√£o uses o OSPF normal. Manda pelo Tunnel1."*

**No Router `Lisbon`:**

```bash
! Rota est√°tica para o IP secund√°rio do Leaf L21 (Porto)
ip route 10.0.0.131 255.255.255.255 Tunnel1

! (Se tiveres mais Leafs no Porto para o Cliente L1, adiciona-os tamb√©m)
! Ex: ip route 10.0.0.132 255.255.255.255 Tunnel1

```

---

### Etapa 4: Configurar o Linux (Leafs) para o Cliente L1

Finalmente, vamos criar o VXLAN do Cliente L1 nos Linux, garantindo que usamos os **IPs Secund√°rios** (`10.0.0.121` e `10.0.0.131`) para que a regra acima funcione.

**1. No Leaf L11 (Lisboa):**

```bash
# VNI 10 para Cliente L1. Nota o "local" com IP 10.0.0.121
ip link add vxlan10 type vxlan id 10 local 10.0.0.121 dstport 4789 nolearning
ip link set up dev vxlan10
ip link add br10 type bridge
ip link set up dev br10
ip link set vxlan10 master br10
# IP para teste
ip addr add 10.10.0.1/24 dev br10

```

**2. No Leaf L21 (Porto):**

```bash
# VNI 10 para Cliente L1. Nota o "local" com IP 10.0.0.131
ip link add vxlan10 type vxlan id 10 local 10.0.0.131 dstport 4789 nolearning
ip link set up dev vxlan10
ip link add br10 type bridge
ip link set up dev br10
ip link set vxlan10 master br10
# IP para teste
ip addr add 10.10.0.2/24 dev br10

```

**Teste Final:**
No L11, faz `ping 10.10.0.2`.
Se responder, o tr√°fego est√° a passar pelo T√∫nel TE com 10Mbps reservados! Podes verificar isso no Cisco `Lisbon` com `show mpls traffic-eng tunnels` (deve mostrar tr√°fego ou contadores a subir).

Avisa-me quando acabares a Etapa 1 e 2 (Cisco) para vermos se o t√∫nel sobe!
